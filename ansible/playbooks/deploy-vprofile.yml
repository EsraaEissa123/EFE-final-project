---
# Playbook 3: Deploy vProfile Application to Kubernetes
# This playbook deploys the complete vProfile stack

- name: Deploy vProfile Application
  hosts: master
  become: yes
  become_user: ubuntu
  vars_files:
    - ../vars/global.yml
  
  tasks:
    - name: Create vProfile namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ app_namespace }}"
            labels:
              name: "{{ app_namespace }}"
    
    - name: Apply ConfigMap
      kubernetes.core.k8s:
        state: present
        src: ../../k8s/configmaps/vprofile-config.yaml
        namespace: "{{ app_namespace }}"
    
    - name: Apply Secrets
      kubernetes.core.k8s:
        state: present
        src: ../../k8s/secrets/vprofile-secrets.yaml
        namespace: "{{ app_namespace }}"
    
    - name: Apply Database Init ConfigMap
      kubernetes.core.k8s:
        state: present
        src: ../../k8s/configmaps/db-init.yaml
        namespace: "{{ app_namespace }}"
    
    - name: Apply NetworkPolicies - Default Deny
      kubernetes.core.k8s:
        state: present
        src: ../../k8s/network-policies/default-deny.yaml
        namespace: "{{ app_namespace }}"
    
    - name: Apply NetworkPolicies - Allow vProfile
      kubernetes.core.k8s:
        state: present
        src: ../../k8s/network-policies/allow-vprofile.yaml
        namespace: "{{ app_namespace }}"
    
    - name: Deploy MySQL Database
      kubernetes.core.k8s:
        state: present
        src: ../../k8s/deployments/vprodb.yaml
        namespace: "{{ app_namespace }}"
    
    - name: Wait for MySQL to be ready
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ app_namespace }}"
        label_selectors:
          - app=vprodb
        wait: yes
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: 300
    
    - name: Deploy Memcached
      kubernetes.core.k8s:
        state: present
        src: ../../k8s/deployments/vprocache.yaml
        namespace: "{{ app_namespace }}"
    
    - name: Wait for Memcached to be ready
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ app_namespace }}"
        label_selectors:
          - app=vprocache
        wait: yes
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: 300
    
    - name: Deploy RabbitMQ
      kubernetes.core.k8s:
        state: present
        src: ../../k8s/deployments/vpromq.yaml
        namespace: "{{ app_namespace }}"
    
    - name: Wait for RabbitMQ to be ready
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ app_namespace }}"
        label_selectors:
          - app=vpromq
        wait: yes
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: 300
    
    - name: Deploy vProfile Application
      kubernetes.core.k8s:
        state: present
        src: ../../k8s/deployments/vproapp.yaml
        namespace: "{{ app_namespace }}"
    
    - name: Wait for vProfile App to be ready
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ app_namespace }}"
        label_selectors:
          - app=vproapp
        wait: yes
        wait_condition:
          type: Ready
          status: "True"
        wait_timeout: 600
    
    - name: Apply All Services
      kubernetes.core.k8s:
        state: present
        src: ../../k8s/services/all-services.yaml
        namespace: "{{ app_namespace }}"
    
    - name: Get deployment status
      shell: kubectl get deployments -n {{ app_namespace }}
      register: deployment_status
    
    - name: Display deployment status
      debug:
        msg: "{{ deployment_status.stdout_lines }}"
    
    - name: Get pods status
      shell: kubectl get pods -n {{ app_namespace }} -o wide
      register: pods_status
    
    - name: Display pods status
      debug:
        msg: "{{ pods_status.stdout_lines }}"
    
    - name: Get services status
      shell: kubectl get svc -n {{ app_namespace }}
      register: services_status
    
    - name: Display services status
      debug:
        msg: "{{ services_status.stdout_lines }}"
    
    - name: Get NetworkPolicies
      shell: kubectl get networkpolicies -n {{ app_namespace }}
      register: netpol_status
    
    - name: Display NetworkPolicies
      debug:
        msg: "{{ netpol_status.stdout_lines }}"
    
    - name: Get NodePort for vProfile service
      shell: kubectl get svc vproapp-service -n {{ app_namespace }} -o jsonpath='{.spec.ports[0].nodePort}'
      register: nodeport
    
    - name: Print deployment summary
      debug:
        msg:
          - "vProfile application deployed successfully!"
          - "Namespace: {{ app_namespace }}"
          - "Access URL: http://<NODE_IP>:{{ nodeport.stdout }}"
          - ""
          - "To check logs: kubectl logs -n {{ app_namespace }} -l app=vproapp"
          - "To scale: kubectl scale deployment vproapp -n {{ app_namespace }} --replicas=5"
