---
# Playbook 2: Initialize Kubernetes Cluster with kubeadm
# This playbook bootstraps the Kubernetes cluster

- name: Initialize Kubernetes Master Node
  hosts: master
  become: yes
  vars_files:
    - ../vars/global.yml
  
  tasks:
    - name: Check if Kubernetes is already initialized
      stat:
        path: /etc/kubernetes/admin.conf
      register: k8s_initialized
    
    - name: Initialize Kubernetes cluster
      shell: |
        kubeadm init \
          --pod-network-cidr={{ pod_network_cidr }} \
          --service-cidr={{ service_cidr }} \
          --apiserver-advertise-address={{ ansible_default_ipv4.address }}
      when: not k8s_initialized.stat.exists
      register: kubeadm_init
    
    - name: Create .kube directory for ubuntu user
      file:
        path: /home/ubuntu/.kube
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'
    
    - name: Copy admin.conf to ubuntu user's kube config
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/ubuntu/.kube/config
        remote_src: yes
        owner: ubuntu
        group: ubuntu
        mode: '0600'
    
    - name: Create .kube directory for root
      file:
        path: /root/.kube
        state: directory
        mode: '0755'
    
    - name: Copy admin.conf to root's kube config
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /root/.kube/config
        remote_src: yes
        mode: '0600'
    
    - name: Install Calico CNI with NetworkPolicy support
      become: yes
      become_user: ubuntu
      shell: |
        kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/{{ calico_version }}/manifests/tigera-operator.yaml
        kubectl create -f https://raw.githubusercontent.com/projectcalico/calico/{{ calico_version }}/manifests/custom-resources.yaml
      when: not k8s_initialized.stat.exists
    
    - name: Wait for Calico pods to be ready
      become: yes
      become_user: ubuntu
      shell: kubectl wait --for=condition=Ready pods --all -n calico-system --timeout=300s
      retries: 3
      delay: 10
    
    - name: Generate join command for worker nodes
      shell: kubeadm token create --print-join-command
      register: join_command
    
    - name: Save join command to file
      copy:
        content: "{{ join_command.stdout }}"
        dest: /tmp/kubernetes_join_command.sh
        mode: '0755'
    
    - name: Fetch join command to local machine
      fetch:
        src: /tmp/kubernetes_join_command.sh
        dest: /tmp/kubernetes_join_command.sh
        flat: yes

- name: Join Worker Nodes to Cluster
  hosts: workers
  become: yes
  
  tasks:
    - name: Check if node is already joined
      stat:
        path: /etc/kubernetes/kubelet.conf
      register: node_joined
    
    - name: Copy join command to worker nodes
      copy:
        src: /tmp/kubernetes_join_command.sh
        dest: /tmp/kubernetes_join_command.sh
        mode: '0755'
      when: not node_joined.stat.exists
    
    - name: Join worker node to cluster
      shell: /tmp/kubernetes_join_command.sh
      when: not node_joined.stat.exists
    
    - name: Remove join command file
      file:
        path: /tmp/kubernetes_join_command.sh
        state: absent

- name: Verify Cluster Status
  hosts: master
  become: yes
  become_user: ubuntu
  
  tasks:
    - name: Wait for all nodes to be Ready
      shell: kubectl get nodes --no-headers | grep -v Ready | wc -l
      register: not_ready_nodes
      until: not_ready_nodes.stdout == "0"
      retries: 10
      delay: 30
    
    - name: Get all nodes status
      shell: kubectl get nodes -o wide
      register: nodes_status
    
    - name: Display nodes status
      debug:
        msg: "{{ nodes_status.stdout_lines }}"
    
    - name: Get all pods status
      shell: kubectl get pods -A
      register: pods_status
    
    - name: Display pods status
      debug:
        msg: "{{ pods_status.stdout_lines }}"
    
    - name: Print cluster initialization summary
      debug:
        msg: "Kubernetes cluster initialized successfully with Calico CNI and NetworkPolicy support!"
